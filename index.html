<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç Multi-Language Voice Learning App</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            color: #333;
        }
        .step {
            margin: 30px 0;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        .step.active {
            background: #f8f9fa;
            border-color: #007cba;
        }
        .step.completed {
            background: #d4edda;
            border-color: #28a745;
        }
        .step h2 {
            margin-top: 0;
            color: #333;
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            margin: 20px 0;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #007cba;
            background: #f0f8ff;
        }
        .csv-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
            max-height: 300px;
            overflow: auto;
        }
        .csv-preview table {
            width: 100%;
            border-collapse: collapse;
        }
        .csv-preview th, .csv-preview td {
            padding: 8px 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .csv-preview th {
            background: #e9ecef;
            font-weight: bold;
        }
        .config-row {
            display: flex;
            align-items: center;
            margin: 15px 0;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .column-preview {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            min-width: 150px;
            font-family: monospace;
            font-size: 14px;
        }
        .voice-select-container {
            position: relative;
            flex: 1;
        }

        .voice-search {
            width: 100%;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 14px;
            background: white;
            box-sizing: border-box;
        }

        .voice-search:focus {
            border-color: #007cba;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 124, 186, 0.3);
        }

        .voice-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .voice-dropdown.show {
            display: block;
        }

        .voice-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .voice-option:hover {
            background-color: #f0f8ff;
        }

        .voice-option.selected {
            background-color: #e3f2fd;
            font-weight: bold;
        }

        .voice-option:last-child {
            border-bottom: none;
        }

        .no-results {
            padding: 12px;
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .test-btn {
            background: #28a745;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-btn:hover {
            background: #218838;
        }
        .word-display {
            text-align: center;
            padding: 40px 20px;
            margin: 20px 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 1.2em;
            line-height: 1.5;
        }
        .row-header {
            font-size: 1em;
            opacity: 0.9;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .word-stack {
            display: block !important;
            text-align: center !important;
            width: 100% !important;
            margin: 20px auto !important;
        }

        .word-item {
            display: block !important;
            text-align: center !important;
            padding: 15px 20px !important;
            background: rgba(255,255,255,0.1) !important;
            border-radius: 10px !important;
            transition: all 0.3s ease !important;
            width: 400px !important;
            margin: 15px auto !important;
            max-width: 90vw !important;
        }

        .word-item.first {
            font-size: 2.5em;
            font-weight: bold;
            padding: 25px 30px;
            background: rgba(255,255,255,0.15);
        }
        .word-item.second {
            font-size: 2em;
            font-weight: 600;
            padding: 20px 25px;
        }
        .word-item.third {
            font-size: 1.7em;
            font-weight: 500;
            padding: 18px 22px;
        }
        .word-item.fourth {
            font-size: 1.4em;
            font-weight: 400;
            padding: 15px 20px;
        }
        .word-item.fifth-plus {
            font-size: 1.2em;
            font-weight: 300;
            padding: 12px 18px;
        }
        .word-item.active {
            background: rgba(255,255,255,0.25);
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.5);
        }
        .word-content {
            flex: 1;
        }
        .word-text {
            display: block;
            margin-bottom: 5px;
        }
        .word-language {
            font-size: 0.6em;
            opacity: 0.8;
            font-weight: normal;
        }
        .language-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin: 5px 0;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            background: #007cba;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #005a8b;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        button.primary {
            background: #28a745;
            font-size: 18px;
            padding: 15px 30px;
        }
        button.primary:hover {
            background: #218838;
        }
        .load-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        .load-btn {
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .load-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        .load-btn.secondary {
            background: #007cba;
        }
        .load-btn.secondary:hover {
            background: #005a8b;
        }
        .progress {
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            height: 8px;
        }
        .progress-bar {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s ease;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #007cba;
        }
        .settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        .setting-row {
            display: flex;
            align-items: center;
            margin: 15px 0;
            gap: 15px;
        }
        .setting-row label {
            min-width: 150px;
            font-weight: bold;
        }
        input[type="range"] {
            flex: 1;
            margin: 0 10px;
        }
        input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .hidden {
            display: none;
        }
        .message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .word-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 20px 0;
        }
        .word-item-list {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            font-family: monospace;
            font-size: 14px;
        }
        .word-item-list:hover {
            background: #f5f5f5;
        }
        .word-item-list.current {
            background: #e3f2fd;
            font-weight: bold;
        }
        @media (max-width: 768px) {
            .config-row {
                flex-direction: column;
                align-items: stretch;
            }
            .column-preview {
                min-width: auto;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üåç Multi-Language Voice Learning App</h1>
    <p><strong>Upload CSV ‚Üí Configure Languages ‚Üí Start Learning</strong></p>

    <!-- Step 1: Upload CSV WITH BUTTONS -->
    <div class="step active" id="step1">
        <h2>üìÑ Step 1: Load CSV File</h2>

        <!-- LOAD BUTTONS -->
        <div class="load-buttons">
            <button class="load-btn" onclick="loadExampleCSV()">
                üìã Load Example CSV
            </button>
            <button class="load-btn secondary" onclick="document.getElementById('csvFile').click()">
                üìÅ Upload Your CSV
            </button>
        </div>

        <p style="text-align: center; margin: 20px 0; color: #666;">
            Or use the upload area below:
        </p>

        <div class="upload-area" id="uploadArea">
            <input type="file" id="csvFile" accept=".csv" style="display: none;">
            <p>üìÅ <strong>Click here or drag & drop your CSV file</strong></p>
            <p style="font-size: 0.9em; color: #666;">CSV with multiple language columns</p>
        </div>
        <div id="uploadMessage"></div>
    </div>

    <!-- Step 2: CSV Preview -->
    <div class="step hidden" id="step2">
        <h2>üëÄ Step 2: CSV Preview</h2>
        <div id="csvPreview" class="csv-preview"></div>
    </div>

    <!-- Step 3: Language Configuration -->
    <div class="step hidden" id="step3">
        <h2>üéØ Step 3: Configure Languages for Each Column</h2>
        <p>Search and select the voice/language for each column, then start learning:</p>
        <div id="languageConfig"></div>
        <div style="text-align: center; margin-top: 25px;">
            <button class="primary" onclick="startLearning()" id="startLearningBtn">üöÄ Start Learning</button>
        </div>
    </div>

    <!-- Step 4: Learning Interface -->
    <div class="step hidden" id="step4">
        <h2>üìö Learning Mode</h2>
        <div id="learningMessage"></div>

        <!-- Settings -->
        <div class="settings">
            <h3>‚öôÔ∏è Settings</h3>
            <div class="setting-row">
                <label>Speech Speed:</label>
                <input type="range" id="speechRate" min="0.5" max="2" value="0.8" step="0.1">
                <span id="rateDisplay">0.8x</span>
            </div>
            <div class="setting-row">
                <label>Pause between words:</label>
                <input type="number" id="pauseTime" value="1500" min="500" max="5000" step="250">
                <span>ms</span>
            </div>
        </div>

        <!-- Word Display -->
        <div class="word-display" id="wordDisplay">
            <div class="row-header">Row <span id="currentRowNumber">1</span></div>
            <div id="wordStack"></div>
            <div class="language-label" id="currentLanguage">Click Start to begin</div>
        </div>

        <!-- Progress -->
        <div class="progress">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button onclick="startPlayback()" id="playBtn">‚ñ∂Ô∏è Play</button>
            <button onclick="pausePlayback()" id="pauseBtn" disabled>‚è∏Ô∏è Pause</button>
            <button onclick="stopPlayback()" id="stopBtn" disabled>‚èπÔ∏è Stop</button>
            <button onclick="previousRow()" id="prevBtn" disabled>‚èÆÔ∏è Previous</button>
            <button onclick="nextRow()" id="nextBtn" disabled>‚è≠Ô∏è Next</button>
            <button onclick="toggleRepeat()" id="repeatBtn">üîÅ Repeat: OFF</button>
        </div>

        <!-- Statistics -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalRows">0</div>
                <div>Total Rows</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="currentRow">0</div>
                <div>Current Row</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="remainingRows">0</div>
                <div>Remaining</div>
            </div>
        </div>

        <!-- Word List -->
        <div class="word-list" id="wordList"></div>
    </div>
</div>

<script>
    let csvData = [];
    let columnCount = 0;
    let languageConfig = {};
    let availableVoices = [];
    let currentRowIndex = 0;
    let currentColumnIndex = 0;
    let isPlaying = false;
    let isPaused = false;
    let repeatMode = false;

    // Load example CSV function
    async function loadExampleCSV() {
        showMessage('üìÇ Loading example.csv...', 'info', 'uploadMessage');

        try {
            const response = await fetch('./example.csv');

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const csvText = await response.text();

            if (!csvText || csvText.trim() === '') {
                throw new Error('Example CSV file is empty');
            }

            // Parse the loaded CSV
            parseCSV(csvText);
            showMessage('‚úÖ Example CSV loaded successfully!', 'success', 'uploadMessage');

        } catch (error) {
            console.error('Error loading example CSV:', error);
            let errorMsg = '‚ùå Could not load example.csv: ';

            if (error.message.includes('404') || error.message.includes('Not Found')) {
                errorMsg += 'File not found. Please make sure example.csv exists in the same folder as this HTML file.';
            } else if (error.message.includes('Failed to fetch')) {
                errorMsg += 'Network error. Make sure you\'re running this from a web server, not opening directly in browser.';
            } else {
                errorMsg += error.message;
            }

            showMessage(errorMsg, 'error', 'uploadMessage');
        }
    }

    // Initialize voices (using working pattern from CodePen)
    function loadVoices() {
        availableVoices = speechSynthesis.getVoices();
        console.log('üé§ Loaded voices:', availableVoices.length);

        if (availableVoices.length > 0) {
            console.log('Available voices:', availableVoices.map(v => `${v.name} (${v.lang})`));
        }
    }

    // Load voices immediately and on change
    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;

    // File upload handling
    document.getElementById('uploadArea').addEventListener('click', function() {
        document.getElementById('csvFile').click();
    });

    document.getElementById('csvFile').addEventListener('change', handleFile);

    // Drag & drop
    document.getElementById('uploadArea').addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    document.getElementById('uploadArea').addEventListener('dragleave', function(e) {
        this.classList.remove('dragover');
    });

    document.getElementById('uploadArea').addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile({target: {files: files}});
        }
    });

    function handleFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        showMessage('üìÇ Reading CSV file...', 'info', 'uploadMessage');

        const reader = new FileReader();
        reader.onload = function(e) {
            parseCSV(e.target.result);
        };
        reader.onerror = function() {
            showMessage('‚ùå Error reading file. Please try again.', 'error', 'uploadMessage');
        };
        reader.readAsText(file);
    }

    function parseCSV(csvText) {
        console.log('üìä Parsing CSV...');

        // Handle different line endings and filter empty lines
        const lines = csvText.split(/\r?\n|\r/).filter(line => line.trim() !== '');

        if (lines.length === 0) {
            showMessage('‚ùå CSV file is empty', 'error', 'uploadMessage');
            return;
        }

        csvData = [];

        // Parse lines
        lines.forEach(function(line, index) {
            const parts = line.split(',').map(p => p.trim().replace(/^"|"$/g, ''));
            if (parts.length > 0 && parts.some(p => p.trim() !== '')) {
                csvData.push(parts);
            }
        });

        if (csvData.length === 0) {
            showMessage('‚ùå No valid data found in CSV', 'error', 'uploadMessage');
            return;
        }

        // Detect column count
        columnCount = Math.max(...csvData.map(row => row.length));
        console.log('üìä Detected', columnCount, 'columns and', csvData.length, 'rows');

        if (columnCount < 1) {
            showMessage('‚ùå CSV must have at least 1 column', 'error', 'uploadMessage');
            return;
        }

        showMessage('‚úÖ CSV loaded successfully! ' + csvData.length + ' rows, ' + columnCount + ' columns', 'success', 'uploadMessage');

        // Show preview and configuration
        showCSVPreview();
        showLanguageConfiguration();

        // Update UI
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step1').classList.add('completed');
        document.getElementById('step2').classList.remove('hidden');
        document.getElementById('step2').classList.add('active');
        document.getElementById('step3').classList.remove('hidden');
        document.getElementById('step3').classList.add('active');
    }

    function showCSVPreview() {
        const previewDiv = document.getElementById('csvPreview');
        let html = '<table><thead><tr>';

        // Header
        for (let i = 0; i < columnCount; i++) {
            html += '<th>Column ' + (i + 1) + '</th>';
        }
        html += '</tr></thead><tbody>';

        // Data rows (show first 5)
        const rowsToShow = Math.min(5, csvData.length);
        for (let i = 0; i < rowsToShow; i++) {
            html += '<tr>';
            for (let j = 0; j < columnCount; j++) {
                const cellData = csvData[i][j] || '';
                html += '<td>' + cellData + '</td>';
            }
            html += '</tr>';
        }

        html += '</tbody></table>';

        if (csvData.length > 5) {
            html += '<p style="text-align: center; color: #666; margin-top: 10px;">... and ' + (csvData.length - 5) + ' more rows</p>';
        }

        previewDiv.innerHTML = html;
    }

    function showLanguageConfiguration() {
        const configDiv = document.getElementById('languageConfig');
        let html = '';

        for (let i = 0; i < columnCount; i++) {
            // Get sample data from column
            const samples = [];
            for (let j = 0; j < Math.min(3, csvData.length); j++) {
                if (csvData[j][i] && csvData[j][i].trim() !== '') {
                    samples.push(csvData[j][i]);
                }
            }
            const sampleText = samples.join(', ') || 'Empty column';

            html += '<div class="config-row">';
            html += '<div class="column-preview">Column ' + (i + 1) + ':<br><small>' + sampleText + '</small></div>';

            // Create searchable voice selector
            html += '<div class="voice-select-container">';
            html += '<input type="text" class="voice-search" id="voice_search_' + i + '" placeholder="Search voices..." onfocus="showVoiceDropdown(' + i + ')" oninput="filterVoices(' + i + ')">';
            html += '<div class="voice-dropdown" id="voice_dropdown_' + i + '"></div>';
            html += '</div>';

            html += '<button class="test-btn" onclick="testColumnVoice(' + i + ')">üîä Test</button>';
            html += '</div>';
        }

        configDiv.innerHTML = html;

        // Initialize voice dropdowns
        setTimeout(() => {
            for (let i = 0; i < columnCount; i++) {
                populateVoiceDropdown(i);
                setDefaultVoice(i);
            }

            // Add click outside listener to close dropdowns
            document.addEventListener('click', function(e) {
                for (let i = 0; i < columnCount; i++) {
                    const dropdown = document.getElementById('voice_dropdown_' + i);
                    const searchInput = document.getElementById('voice_search_' + i);
                    if (dropdown && searchInput && !searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.remove('show');
                    }
                }
            });
        }, 100);
    }

    function populateVoiceDropdown(columnIndex) {
        const dropdown = document.getElementById('voice_dropdown_' + columnIndex);
        if (!dropdown) return;

        let html = '';

        // Add "Select a voice" option
        html += '<div class="voice-option" onclick="selectVoice(' + columnIndex + ', \'\', \'Select a voice...\')">Select a voice...</div>';

        // Add all available voices
        availableVoices.forEach(voice => {
            const displayText = voice.name + ' (' + voice.lang + ')';
            html += '<div class="voice-option" onclick="selectVoice(' + columnIndex + ', \'' + voice.name.replace(/'/g, "\\'") + '\', \'' + displayText.replace(/'/g, "\\'") + '\')">' + displayText + '</div>';
        });

        dropdown.innerHTML = html;
    }

    function showVoiceDropdown(columnIndex) {
        // Hide all other dropdowns first
        for (let i = 0; i < columnCount; i++) {
            if (i !== columnIndex) {
                const otherDropdown = document.getElementById('voice_dropdown_' + i);
                if (otherDropdown) {
                    otherDropdown.classList.remove('show');
                }
            }
        }

        // Show current dropdown
        const dropdown = document.getElementById('voice_dropdown_' + columnIndex);
        if (dropdown) {
            dropdown.classList.add('show');
            filterVoices(columnIndex); // Apply any current filter
        }
    }

    function filterVoices(columnIndex) {
        const searchInput = document.getElementById('voice_search_' + columnIndex);
        const dropdown = document.getElementById('voice_dropdown_' + columnIndex);

        if (!searchInput || !dropdown) return;

        const searchTerm = searchInput.value.toLowerCase();
        let html = '';
        let hasResults = false;

        // Add "Select a voice" option if no search term
        if (!searchTerm) {
            html += '<div class="voice-option" onclick="selectVoice(' + columnIndex + ', \'\', \'Select a voice...\')">Select a voice...</div>';
            hasResults = true;
        }

        // Filter and add matching voices
        availableVoices.forEach(voice => {
            const displayText = voice.name + ' (' + voice.lang + ')';
            if (displayText.toLowerCase().includes(searchTerm)) {
                html += '<div class="voice-option" onclick="selectVoice(' + columnIndex + ', \'' + voice.name.replace(/'/g, "\\'") + '\', \'' + displayText.replace(/'/g, "\\'") + '\')">' + displayText + '</div>';
                hasResults = true;
            }
        });

        // Show "no results" if no matches
        if (!hasResults) {
            html += '<div class="no-results">No voices found matching "' + searchTerm + '"</div>';
        }

        dropdown.innerHTML = html;
        dropdown.classList.add('show');
    }

    function selectVoice(columnIndex, voiceName, displayText) {
        const searchInput = document.getElementById('voice_search_' + columnIndex);
        const dropdown = document.getElementById('voice_dropdown_' + columnIndex);

        if (searchInput) {
            searchInput.value = displayText;
            searchInput.setAttribute('data-voice-name', voiceName);
        }

        if (dropdown) {
            dropdown.classList.remove('show');
        }

        console.log('Selected voice for column ' + columnIndex + ':', voiceName);
    }

    function setDefaultVoice(columnIndex) {
        if (availableVoices.length === 0) return;

        let defaultVoice = null;

        // Try to find good default voices
        if (columnIndex === 0) {
            // First column - try Japanese
            defaultVoice = availableVoices.find(v => v.lang.startsWith('ja'));
        } else if (columnIndex === 1) {
            // Second column - try English
            defaultVoice = availableVoices.find(v => v.lang.startsWith('en'));
        }

        if (!defaultVoice) {
            defaultVoice = availableVoices[columnIndex % availableVoices.length];
        }

        if (defaultVoice) {
            const displayText = defaultVoice.name + ' (' + defaultVoice.lang + ')';
            selectVoice(columnIndex, defaultVoice.name, displayText);
        }
    }

    function testColumnVoice(columnIndex) {
        const searchInput = document.getElementById('voice_search_' + columnIndex);
        const selectedVoiceName = searchInput ? searchInput.getAttribute('data-voice-name') : '';

        if (!selectedVoiceName) {
            alert('Please select a voice first');
            return;
        }

        // Get sample text
        const sampleText = csvData[0] && csvData[0][columnIndex] ? csvData[0][columnIndex] : 'Test voice';

        // Find the voice
        const voice = availableVoices.find(v => v.name === selectedVoiceName);

        if (voice) {
            const utterance = new SpeechSynthesisUtterance(sampleText);
            utterance.voice = voice;
            utterance.rate = 0.8;
            speechSynthesis.speak(utterance);
            console.log('üîä Testing:', voice.name, '(' + voice.lang + ') with text:', sampleText);
        }
    }

    function startLearning() {
        // Validate configuration
        languageConfig = {};

        for (let i = 0; i < columnCount; i++) {
            const searchInput = document.getElementById('voice_search_' + i);
            const selectedVoiceName = searchInput ? searchInput.getAttribute('data-voice-name') : '';

            if (!selectedVoiceName) {
                alert('Please select a voice for Column ' + (i + 1));
                return;
            }

            const voice = availableVoices.find(v => v.name === selectedVoiceName);
            if (voice) {
                languageConfig[i] = voice;
            }
        }

        console.log('üöÄ Language configuration:', languageConfig);

        // Initialize learning interface
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step3').classList.remove('active');
        document.getElementById('step3').classList.add('completed');
        document.getElementById('step4').classList.remove('hidden');
        document.getElementById('step4').classList.add('active');

        // Reset state
        currentRowIndex = 0;
        currentColumnIndex = 0;
        updateDisplay();
        updateStats();
        updateWordList();

        showMessage('‚úÖ Ready to start learning! ' + csvData.length + ' rows with ' + Object.keys(languageConfig).length + ' languages configured.', 'success', 'learningMessage');
    }

    function startPlayback() {
        if (csvData.length === 0) {
            alert('No data to play');
            return;
        }

        isPlaying = true;
        isPaused = false;
        updateButtons();

        playCurrentSequence();
    }

    function playCurrentSequence() {
        if (!isPlaying || isPaused) return;

        const row = csvData[currentRowIndex];
        if (!row) {
            // End of data
            stopPlayback();
            alert('üéâ Completed all rows!');
            return;
        }

        if (currentColumnIndex >= columnCount || currentColumnIndex >= Object.keys(languageConfig).length) {
            // End of current row, move to next
            currentColumnIndex = 0;
            currentRowIndex++;

            if (repeatMode && currentRowIndex >= csvData.length) {
                currentRowIndex = 0; // Loop back
            }

            // Pause between rows
            const pauseTime = parseInt(document.getElementById('pauseTime').value);
            setTimeout(() => {
                if (isPlaying && !isPaused) {
                    playCurrentSequence();
                }
            }, pauseTime);
            return;
        }

        // Play current cell
        const text = row[currentColumnIndex] || '';
        const voice = languageConfig[currentColumnIndex];

        if (text && voice) {
            updateDisplay();
            updateStats();
            updateWordList();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = voice;
            utterance.rate = parseFloat(document.getElementById('speechRate').value);

            utterance.onend = function() {
                currentColumnIndex++;
                setTimeout(() => {
                    if (isPlaying && !isPaused) {
                        playCurrentSequence();
                    }
                }, 800); // Short pause between words
            };

            speechSynthesis.speak(utterance);
            console.log('üîä Playing:', text, 'with voice:', voice.name);
        } else {
            // Skip empty cells
            currentColumnIndex++;
            setTimeout(() => {
                if (isPlaying && !isPaused) {
                    playCurrentSequence();
                }
            }, 100);
        }
    }

    function pausePlayback() {
        isPaused = true;
        speechSynthesis.pause();
        updateButtons();
    }

    function stopPlayback() {
        isPlaying = false;
        isPaused = false;
        speechSynthesis.cancel();
        currentRowIndex = 0;
        currentColumnIndex = 0;
        updateDisplay();
        updateStats();
        updateWordList();
        updateButtons();
    }

    function nextRow() {
        if (currentRowIndex < csvData.length - 1) {
            currentRowIndex++;
            currentColumnIndex = 0;
            updateDisplay();
            updateStats();
            updateWordList();
        }
    }

    function previousRow() {
        if (currentRowIndex > 0) {
            currentRowIndex--;
            currentColumnIndex = 0;
            updateDisplay();
            updateStats();
            updateWordList();
        }
    }

    function toggleRepeat() {
        repeatMode = !repeatMode;
        document.getElementById('repeatBtn').textContent = 'üîÅ Repeat: ' + (repeatMode ? 'ON' : 'OFF');
    }

    function updateDisplay() {
        if (csvData.length === 0) return;

        const row = csvData[currentRowIndex];
        if (!row) return;

        // Update row number
        document.getElementById('currentRowNumber').textContent = currentRowIndex + 1;

        // Create word stack display - show ALL words from current row
        const stackDiv = document.getElementById('wordStack');
        stackDiv.innerHTML = '';

        // DEBUGGING: Add explicit styles to the container
        stackDiv.style.textAlign = 'center';
        stackDiv.style.width = '100%';
        stackDiv.style.display = 'block';
        stackDiv.style.overflowX = 'hidden'; // Prevent horizontal scroll

        // Get all configured columns for this row
        const configuredColumns = Object.keys(languageConfig).map(i => parseInt(i)).sort((a, b) => a - b);

        configuredColumns.forEach((columnIndex, displayIndex) => {
            const wordDiv = document.createElement('div');

            // Assign size classes based on position
            let sizeClass = 'fifth-plus'; // default for 5+
            if (displayIndex === 0) sizeClass = 'first';
            else if (displayIndex === 1) sizeClass = 'second';
            else if (displayIndex === 2) sizeClass = 'third';
            else if (displayIndex === 3) sizeClass = 'fourth';

            // Add active class if currently playing
            const isActive = columnIndex === currentColumnIndex;
            wordDiv.className = `word-item ${sizeClass}${isActive ? ' active' : ''}`;

            // FORCE CENTERING WITH INLINE STYLES
            wordDiv.style.display = 'block';
            wordDiv.style.margin = '15px auto';
            wordDiv.style.textAlign = 'center';
            wordDiv.style.width = '400px';
            wordDiv.style.maxWidth = '90vw';

            const word = row[columnIndex] || 'Empty';
            const voice = languageConfig[columnIndex];

            wordDiv.innerHTML = `
                    <div class="word-content">
                        <span class="word-text">${word}</span>
                        <div class="word-language">${voice.name} (${voice.lang})</div>
                    </div>
                `;

            stackDiv.appendChild(wordDiv);
        });

        // Update status message
        if (isPlaying && !isPaused) {
            const currentVoice = languageConfig[currentColumnIndex];
            const status = currentVoice ? `üîä Playing: ${currentVoice.name}` : 'Playing...';
            document.getElementById('currentLanguage').textContent = status;
        } else {
            document.getElementById('currentLanguage').textContent = `Row ${currentRowIndex + 1} of ${csvData.length}`;
        }

        // Update progress
        const progress = csvData.length > 0 ? ((currentRowIndex + 1) / csvData.length) * 100 : 0;
        document.getElementById('progressBar').style.width = progress + '%';
    }

    function updateStats() {
        document.getElementById('totalRows').textContent = csvData.length;
        document.getElementById('currentRow').textContent = currentRowIndex + 1;
        document.getElementById('remainingRows').textContent = csvData.length - currentRowIndex - 1;
    }

    function updateWordList() {
        const listDiv = document.getElementById('wordList');
        listDiv.innerHTML = '';

        csvData.forEach((row, index) => {
            const item = document.createElement('div');
            item.className = 'word-item-list' + (index === currentRowIndex ? ' current' : '');

            let displayText = `Row ${index + 1}: `;
            const words = [];
            for (let i = 0; i < columnCount; i++) {
                if (row[i]) words.push(row[i]);
            }
            displayText += words.join(' ‚Üí ');

            item.textContent = displayText;
            item.onclick = function() {
                currentRowIndex = index;
                currentColumnIndex = 0;
                updateDisplay();
                updateStats();
                updateWordList();
            };

            listDiv.appendChild(item);
        });
    }

    function updateButtons() {
        document.getElementById('playBtn').disabled = isPlaying && !isPaused;
        document.getElementById('pauseBtn').disabled = !isPlaying || isPaused;
        document.getElementById('stopBtn').disabled = !isPlaying && !isPaused;
        document.getElementById('nextBtn').disabled = csvData.length === 0;
        document.getElementById('prevBtn').disabled = csvData.length === 0;
    }

    function showMessage(message, type, containerId) {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = `<div class="message ${type}">${message}</div>`;

            if (type !== 'error') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 3000);
            }
        }
    }

    // Settings updates
    document.getElementById('speechRate').addEventListener('input', function() {
        document.getElementById('rateDisplay').textContent = this.value + 'x';
    });

    // Check TTS support
    if (!('speechSynthesis' in window)) {
        showMessage('‚ùå Speech Synthesis not supported in this browser. Please use Chrome, Safari, or Firefox.', 'error', 'uploadMessage');
    } else {
        console.log('‚úÖ Speech Synthesis supported');
    }

    console.log('üöÄ Multi-Language Voice Learning App Ready!');
</script>
</body>
</html>